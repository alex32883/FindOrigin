# План реализации Telegram-бота FindOrigin

## Этап 1: Настройка проекта и окружения

1.1. Инициализация Next.js проекта
   - Создать новый Next.js проект с TypeScript
   - Настроить структуру папок (app или pages router)
   - Установить необходимые зависимости

1.2. Настройка переменных окружения
   - Создать `.env.local` файл
   - Добавить переменные:
     - `TELEGRAM_BOT_TOKEN` - токен бота от BotFather
     - `TELEGRAM_API_URL` - базовый URL Telegram API
     - `AI_API_KEY` - ключ для AI сервиса (OpenAI/Anthropic/etc.)
     - `WEBHOOK_SECRET` - секрет для верификации webhook (опционально)

1.3. Настройка TypeScript и линтеров
   - Проверить конфигурацию TypeScript
   - Настроить ESLint/Prettier (если нужно)

## Этап 2: Создание Telegram бота

2.1. Регистрация бота
   - Создать бота через @BotFather в Telegram
   - Получить токен бота
   - Сохранить токен в переменные окружения

2.2. Настройка webhook (для Vercel)
   - Создать API route для приема webhook от Telegram
   - Реализовать endpoint `/api/webhook` (POST)
   - Настроить верификацию запросов (опционально)

## Этап 3: Реализация обработчика webhook

3.1. Базовый обработчик webhook
   - Создать API route handler в Next.js
   - Парсить входящий update от Telegram
   - Извлечь `chat.id` и `text` из `update.message`
   - Вернуть 200 OK быстро (асинхронная обработка)

3.2. Обработка разных типов сообщений
   - Текстовые сообщения
   - Сообщения со ссылками на Telegram-посты
   - Обработка ошибок и некорректных данных

3.3. Асинхронная обработка
   - Отправить быстрый ответ пользователю ("Обрабатываю...")
   - Выполнить основную логику в фоне
   - Отправить финальный результат через Telegram API

## Этап 4: Извлечение текста из Telegram-постов

4.1. Парсинг ссылок на Telegram-посты
   - Определить формат ссылок (t.me/channel/123)
   - Реализовать функцию извлечения channel/username и post_id
   - Использовать Telegram API для получения поста (если возможно)
   - Альтернатива: парсинг через веб-скрапинг (если API недоступно)

4.2. Извлечение текста из поста
   - Получить полный текст поста
   - Обработать форматирование (Markdown/HTML)
   - Извлечь медиа-описания (если есть)

## Этап 5: Анализ и извлечение ключевой информации

5.1. Извлечение ключевых утверждений
   - Использовать NLP/AI для выделения основных тезисов
   - Определить главные утверждения в тексте

5.2. Извлечение структурированных данных
   - Даты (распознавание различных форматов)
   - Числа и статистика
   - Имена собственные (люди, организации, места)
   - Ссылки (если уже есть в тексте)

5.3. Создание поисковых запросов
   - Сформировать поисковые запросы на основе извлеченной информации
   - Оптимизировать запросы для поиска источников

## Этап 6: Поиск источников

6.1. Интеграция с поисковыми системами
   - Выбрать поисковый API (Google Search API, Bing API, или веб-скрапинг)
   - Реализовать функцию поиска по ключевым словам
   - Фильтрация результатов по типам источников:
     - Официальные сайты (.gov, .edu, официальные организации)
     - Новостные сайты
     - Блоги и аналитика
     - Исследовательские работы

6.2. Сбор кандидатов на источники
   - Получить топ-10-20 результатов поиска
   - Извлечь заголовки, описания, URL
   - Предварительная фильтрация по релевантности

## Этап 7: AI-сравнение и ранжирование

7.1. Интеграция с AI сервисом
   - Выбрать AI провайдера (OpenAI GPT, Anthropic Claude, etc.)
   - Настроить API клиент
   - Создать промпты для сравнения смысла

7.2. Сравнение смысла
   - Для каждого кандидата-источника:
     - Извлечь основной контент (заголовок, описание, начало статьи)
     - Сравнить смысл с исходным текстом через AI
     - Получить оценку релевантности (0-100%)

7.3. Ранжирование и выбор
   - Отсортировать источники по оценке релевантности
   - Выбрать топ-3 источника
   - Рассчитать общую оценку уверенности

## Этап 8: Форматирование и отправка ответа

8.1. Форматирование результата
   - Создать структурированный ответ:
     - Список источников (1-3 ссылки)
     - Оценка уверенности для каждого
     - Общая оценка уверенности
   - Использовать Markdown для форматирования

8.2. Отправка через Telegram API
   - Использовать метод `sendMessage`
   - Отправить отформатированный ответ пользователю
   - Обработать ошибки отправки

## Этап 9: Обработка ошибок и edge cases

9.1. Обработка ошибок
   - Ошибки парсинга текста
   - Ошибки поиска источников
   - Ошибки AI API
   - Ошибки Telegram API
   - Таймауты

9.2. Edge cases
   - Текст без ключевой информации
   - Не найдено источников
   - Низкая уверенность (< 30%)
   - Очень длинные тексты
   - Невалидные ссылки на посты

## Этап 10: Тестирование

10.1. Локальное тестирование
   - Тестирование webhook handler
   - Тестирование извлечения текста
   - Тестирование поиска источников
   - Тестирование AI сравнения
   - Интеграционное тестирование

10.2. Тестирование с реальным ботом
   - Настроить локальный туннель (ngrok) для webhook
   - Протестировать различные сценарии
   - Проверить производительность

## Этап 11: Деплой на Vercel

11.1. Подготовка к деплою
   - Настроить переменные окружения в Vercel
   - Проверить конфигурацию Next.js
   - Оптимизировать для production

11.2. Деплой
   - Подключить репозиторий к Vercel
   - Настроить автоматический деплой
   - Получить URL приложения

11.3. Настройка webhook в Telegram
   - Установить webhook через Telegram API
   - Указать URL: `https://your-app.vercel.app/api/webhook`
   - Проверить работу webhook

## Этап 12: Оптимизация и улучшения

12.1. Оптимизация производительности
   - Кэширование результатов поиска
   - Оптимизация AI запросов (batch processing)
   - Асинхронная обработка длительных операций

12.2. Улучшение точности
   - Тонкая настройка промптов для AI
   - Улучшение извлечения ключевой информации
   - Расширение базы источников

12.3. Дополнительные функции (опционально)
   - История запросов пользователя
   - Поддержка нескольких языков
   - Уведомления о новых источниках
   - Статистика использования

## Порядок приоритетов

**Критический путь (MVP):**
- Этапы 1-3: Базовая инфраструктура и webhook
- Этап 4: Извлечение текста (хотя бы для обычных сообщений)
- Этап 5: Базовое извлечение информации
- Этап 6: Простой поиск источников
- Этап 7: Базовое AI сравнение
- Этап 8: Отправка результатов
- Этап 11: Деплой

**Второстепенные задачи:**
- Этап 9: Обработка ошибок (базовая)
- Этап 10: Тестирование
- Этап 12: Оптимизация
